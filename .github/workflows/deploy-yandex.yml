name: Deploy to Yandex Cloud

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # Ручной запуск

env:
  REGISTRY: cr.yandex
  REGISTRY_ID: crp8htjr9iulov5vtf0l
  IMAGE_NAME: moex-agent
  CONTAINER_NAME: moex-agent
  FOLDER_ID: b1g58hgssbaevs2m924t
  SERVICE_ACCOUNT_ID: ajeopktlqun8vakd75m6

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Yandex Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: json_key
          password: ${{ secrets.YC_SA_JSON_KEY }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deploy/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.REGISTRY_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n -i ~/yandex-cloud
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        run: |
          echo '${{ secrets.YC_SA_JSON_KEY }}' > sa-key.json
          ~/yandex-cloud/bin/yc config set service-account-key sa-key.json
          ~/yandex-cloud/bin/yc config set folder-id ${{ env.FOLDER_ID }}
          rm sa-key.json

      - name: Create Serverless Container (if not exists)
        run: |
          if ! ~/yandex-cloud/bin/yc serverless container get --name ${{ env.CONTAINER_NAME }} 2>/dev/null; then
            ~/yandex-cloud/bin/yc serverless container create --name ${{ env.CONTAINER_NAME }}
          fi

      - name: Deploy new revision
        run: |
          ~/yandex-cloud/bin/yc serverless container revision deploy \
            --container-name ${{ env.CONTAINER_NAME }} \
            --image ${{ env.REGISTRY }}/${{ env.REGISTRY_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --service-account-id ${{ env.SERVICE_ACCOUNT_ID }} \
            --memory 1024Mi \
            --cores 1 \
            --core-fraction 100 \
            --execution-timeout 300s \
            --concurrency 1 \
            --environment "DATABASE_URL=${{ secrets.DATABASE_URL }},PORT=8080,TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }},TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}"

      - name: Allow unauthenticated access
        run: |
          CONTAINER_ID=$(~/yandex-cloud/bin/yc serverless container get --name ${{ env.CONTAINER_NAME }} --format json | jq -r '.id')
          ~/yandex-cloud/bin/yc serverless container allow-unauthenticated-invoke --id $CONTAINER_ID || true

      - name: Get Container URL
        run: |
          CONTAINER_URL=$(~/yandex-cloud/bin/yc serverless container get --name ${{ env.CONTAINER_NAME }} --format json | jq -r '.url')
          echo "## Deployment Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Container URL:** $CONTAINER_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Dashboard: $CONTAINER_URL/" >> $GITHUB_STEP_SUMMARY
          echo "- Health: $CONTAINER_URL/api/health" >> $GITHUB_STEP_SUMMARY
          echo "- API: $CONTAINER_URL/api/status" >> $GITHUB_STEP_SUMMARY
