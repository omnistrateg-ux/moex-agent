# MOEX Agent ‚Äî –ü—Ä–æ–º–ø—Ç –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π –≤ Replit

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

–≠—Ç–æ —Ç–æ—Ä–≥–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –ú–æ—Å–∫–æ–≤—Å–∫–æ–π –±–∏—Ä–∂–∏ —Å ML-–ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ–º. –ú–æ–¥–µ–ª–∏ —É–∂–µ –æ–±—É—á–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç, –Ω–æ –Ω—É–∂–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å **–ø–µ—Ä–µ–æ–±—É—á–∞—Ç—å –∏—Ö –ø—Ä—è–º–æ –≤ Replit**.

---

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –û–±—É—á–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ (–≤ –ø–∞–ø–∫–µ `models/`):

| –ú–æ–¥–µ–ª—å | Win Rate | Profit Factor | –°—Ç–∞—Ç—É—Å |
|--------|----------|---------------|--------|
| model_time_5m.joblib | 56.8% | 2.33 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| model_time_10m.joblib | 56.0% | 2.31 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| model_time_30m.joblib | 56.0% | 2.39 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| model_time_1h.joblib | 55.4% | 2.39 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |

### –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è:

1. –î–∞–Ω–Ω—ã–µ —Å MOEX (—Å–≤–µ—á–∏) ‚Äî –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. 29 —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ ‚Äî —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ `features.py`
3. Walk-Forward –≤–∞–ª–∏–¥–∞—Ü–∏—è ‚Äî —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ `advanced_train.py`

---

## –ó–∞–¥–∞—á–∞: –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è –¥–ª—è Replit

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:

1. **–ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—É—Å–∫** –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π –≤ Shell:
   ```bash
   python scripts/retrain.py
   ```

2. **–≠—Ç–∞–ø—ã —Ä–∞–±–æ—Ç—ã:**
   - –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ —Å MOEX (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)
   - –ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Ñ–∏—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–∫–µ—Ä–∞
   - –û–±—É—á–∏—Ç—å –º–æ–¥–µ–ª–∏ —Å Walk-Forward –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ –≤ `models/`
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram

3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è Replit:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ–Ω—å—à–µ –ø–∞–º—è—Ç–∏ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–æ –æ–¥–Ω–æ–º—É —Ç–∏–∫–µ—Ä—É)
   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –∫–æ–Ω—Å–æ–ª–∏
   - –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

---

## –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### features.py ‚Äî 29 –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤:

```python
from moex_agent.features import build_feature_frame, FEATURE_COLS

# FEATURE_COLS —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö 29 —Ñ–∏—á:
# ['ret_1', 'ret_5', 'ret_10', 'ret_20', 'log_ret_1',
#  'atr_14', 'atr_pct', 'bb_width', 'bb_pct',
#  'rsi_14', 'macd', 'macd_signal', 'macd_hist',
#  'stoch_k', 'stoch_d', 'willr_14', 'cci_20', 'mfi_14',
#  'adx_14', 'plus_di', 'minus_di', 'ema_ratio',
#  'obv_ratio', 'vwap_dist', 'volume_ratio',
#  'hour', 'minute', 'day_of_week']

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
candles = [{"ts": "...", "open": 100, "high": 101, ...}, ...]
df = build_feature_frame(candles)
X = df[FEATURE_COLS]
```

### labels.py ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ç–æ–∫:

```python
from moex_agent.labels import create_labels

# horizon: "5m", "10m", "30m", "1h"
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: 1 –µ—Å–ª–∏ —Ü–µ–Ω–∞ –≤—ã—Ä–æ—Å–ª–∞, 0 –µ—Å–ª–∏ —É–ø–∞–ª–∞
labels = create_labels(candles_df, horizon="5m")
```

### storage.py ‚Äî —Ä–∞–±–æ—Ç–∞ —Å –ë–î:

```python
from moex_agent.storage import connect

conn = connect("data/moex_agent.sqlite")
candles = conn.execute("SELECT * FROM candles WHERE secid = ?", (ticker,)).fetchall()
```

### bootstrap.py ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö:

```python
from moex_agent.bootstrap import bootstrap_recent
from moex_agent.config_schema import load_config

config = load_config()
conn = connect(config.sqlite_path)
bootstrap_recent(conn, config, days=30)  # –ó–∞–≥—Ä—É–∑–∏—Ç—å 30 –¥–Ω–µ–π
```

### telegram.py ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:

```python
from moex_agent.telegram import send_telegram

send_telegram("‚úÖ –ú–æ–¥–µ–ª–∏ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω—ã!")
```

---

## –ê–ª–≥–æ—Ä–∏—Ç–º –æ–±—É—á–µ–Ω–∏—è (Walk-Forward)

```python
from sklearn.model_selection import TimeSeriesSplit
from sklearn.ensemble import GradientBoostingClassifier

def train_model(X, y, n_splits=5):
    """
    Walk-Forward –≤–∞–ª–∏–¥–∞—Ü–∏—è:
    - –†–∞–∑–±–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ 5 –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫–æ–Ω
    - –û–±—É—á–∞–µ–º –Ω–∞ –ø—Ä–æ—à–ª—ã—Ö –¥–∞–Ω–Ω—ã—Ö, —Ç–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ –±—É–¥—É—â–∏—Ö
    - –ù–µ—Ç —É—Ç–µ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö!
    """
    tscv = TimeSeriesSplit(n_splits=n_splits)

    best_model = None
    best_score = 0

    for fold, (train_idx, test_idx) in enumerate(tscv.split(X)):
        model = GradientBoostingClassifier(
            n_estimators=100,
            max_depth=5,
            learning_rate=0.1,
            min_samples_split=50,
            min_samples_leaf=20,
            random_state=42,
        )

        model.fit(X.iloc[train_idx], y.iloc[train_idx])
        score = model.score(X.iloc[test_idx], y.iloc[test_idx])

        if score > best_score:
            best_score = score
            best_model = model

    return best_model, best_score
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∫—Ä–∏–ø—Ç–∞ retrain.py

```python
#!/usr/bin/env python3
"""
–ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ ML –º–æ–¥–µ–ª–µ–π –≤ Replit.

–ó–∞–ø—É—Å–∫:
    python scripts/retrain.py [--days 30] [--horizon 5m]
"""

import argparse
import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å
sys.path.insert(0, str(Path(__file__).parent.parent))

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--days", type=int, default=30, help="–î–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö")
    parser.add_argument("--horizon", type=str, help="–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≥–æ—Ä–∏–∑–æ–Ω—Ç (5m/10m/30m/1h)")
    args = parser.parse_args()

    # 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    print("üìä –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å MOEX...")
    # ... bootstrap_recent() ...

    # 2. –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
    horizons = [args.horizon] if args.horizon else ["5m", "10m", "30m", "1h"]

    for horizon in horizons:
        print(f"\nüîÑ –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ {horizon}...")
        # ... train_model() ...
        # ... joblib.dump() ...

    # 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    print("\n‚úÖ –ì–æ—Ç–æ–≤–æ!")
    # ... send_telegram() ...

if __name__ == "__main__":
    main()
```

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π

```python
MODEL_PARAMS = {
    "n_estimators": 100,      # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ä–µ–≤—å–µ–≤
    "max_depth": 5,           # –ì–ª—É–±–∏–Ω–∞ –¥–µ—Ä–µ–≤–∞
    "learning_rate": 0.1,     # –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è
    "min_samples_split": 50,  # –ú–∏–Ω. samples –¥–ª—è split
    "min_samples_leaf": 20,   # –ú–∏–Ω. samples –≤ –ª–∏—Å—Ç–µ
    "random_state": 42,       # –î–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏
}

HORIZONS = ["5m", "10m", "30m", "1h"]
N_SPLITS = 5  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ Walk-Forward splits
```

---

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ `python scripts/retrain.py`:

```
üìä –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å MOEX...
   –ó–∞–≥—Ä—É–∂–µ–Ω–æ: 150,000 —Å–≤–µ—á–µ–π

üîÑ –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ 5m...
   Fold 1: accuracy=0.54, win_rate=0.56
   Fold 2: accuracy=0.55, win_rate=0.57
   Fold 3: accuracy=0.54, win_rate=0.55
   Fold 4: accuracy=0.55, win_rate=0.58
   Fold 5: accuracy=0.56, win_rate=0.57
   ‚úÖ –ú–æ–¥–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: models/model_time_5m.joblib
   –ú–µ—Ç—Ä–∏–∫–∏: WR=56.6%, Acc=54.8%

üîÑ –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ 10m...
   ...

üîÑ –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ 30m...
   ...

üîÑ –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ 1h...
   ...

‚úÖ –í—Å–µ –º–æ–¥–µ–ª–∏ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω—ã!
üì± –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram
```

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ `data/retrain.log`

2. **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ** ‚Äî –æ–±–Ω–æ–≤–ª—è—Ç—å `models/meta.json`:
   ```json
   {
     "trained_at": "2026-01-22T15:30:00",
     "platform": "Replit",
     "horizons": {
       "5m": {"win_rate": 0.566, "accuracy": 0.548},
       ...
     }
   }
   ```

3. **Backup** ‚Äî –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ–º –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –º–æ–¥–µ–ª–∏ –≤ `models/backup/`

4. **–í–∞–ª–∏–¥–∞—Ü–∏—è** ‚Äî –ø—Ä–æ–≤–µ—Ä—è—Ç—å —á—Ç–æ –Ω–æ–≤–∞—è –º–æ–¥–µ–ª—å –ª—É—á—à–µ —Å—Ç–∞—Ä–æ–π (–∏–Ω–∞—á–µ –Ω–µ –∑–∞–º–µ–Ω—è—Ç—å)

---

## –§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è

1. **–°–æ–∑–¥–∞—Ç—å:** `scripts/retrain.py` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è
2. **–°–æ–∑–¥–∞—Ç—å:** `scripts/validate_model.py` ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –º–æ–¥–µ–ª–∏
3. **–ò–∑–º–µ–Ω–∏—Ç—å:** `moex_agent/advanced_train.py` ‚Äî –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

---

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è Replit Shell

```bash
# –ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å –≤—Å–µ –º–æ–¥–µ–ª–∏
python scripts/retrain.py

# –ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ 5-–º–∏–Ω—É—Ç–Ω—É—é –º–æ–¥–µ–ª—å
python scripts/retrain.py --horizon 5m

# –ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–∞–Ω–Ω—ã—Ö
python scripts/retrain.py --days 60

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–µ–π
python scripts/validate_model.py
```

---

## –í–∞–∂–Ω–æ

- **–ü–∞–º—è—Ç—å:** Replit –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—É—é –ø–∞–º—è—Ç—å. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —á–∞—Å—Ç—è–º.
- **–í—Ä–µ–º—è:** –û–±—É—á–µ–Ω–∏–µ –∑–∞–Ω–∏–º–∞–µ—Ç 10-30 –º–∏–Ω—É—Ç. –ü–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å.
- **Backup:** –í—Å–µ–≥–¥–∞ –¥–µ–ª–∞–π—Ç–µ backup –ø–µ—Ä–µ–¥ –∑–∞–º–µ–Ω–æ–π –º–æ–¥–µ–ª–µ–π.
- **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª—É—á—à–µ —Å—Ç–∞—Ä–æ–π!
